---
- name: Update apt cache (Debian)
  when: ansible_os_family == 'Debian'
  tags: molecule-idempotence-notest
  apt:
    update_cache: true

- name: Install OpenVPN and Nginx
  package:
    name:
      - openvpn
      - tar
      - nginx
      - python3-passlib
      - jq
    state: present

# ovpn-admin user account configuration.
- name: Add a deployment user.
  user:
    name: ovpn-admin
    state: present

- name: Add sudo rights for deployment user.
  lineinfile:
    dest: /etc/sudoers
    regexp: '^ovpn-admin'
    line: 'ovpn-admin ALL=(ALL) NOPASSWD: ALL'
    state: present
    validate: 'visudo -cf %s'

- name: Ensure /etc/openvpn/easy-rsa exists
  ansible.builtin.file:
    path: /etc/openvpn/easy-rsa
    state: directory
    mode: "0755"

- name: Does EasyRSA already downloaded?
  stat:
    path: "{{ openvpn_easyrsa_path }}/easyrsa"
  register: register_easyrsa

- name: Does ovpn-admin already downloaded?
  stat:
    path: "{{ ovpn_admin_path }}/ovpn-admin"
  register: register_ovpn_admin

- block:
    - name: Determine latest GitHub release
      become: false
      uri:
        url: "https://api.github.com/repos/OpenVPN/easy-rsa/releases/latest"
        body_format: json
      register: _github_release
      when: not register_easyrsa.stat.exists
      until: _github_release.status == 200
      retries: 5

    - name: Set easyrsa_version
      when: not register_easyrsa.stat.exists
      set_fact:
        easyrsa_version: "{{ _github_release.json.tag_name
          | regex_replace('^v?(.*)$', '\\1') }}"
  when: (easyrsa_version is not defined) or (easyrsa_version == 'latest')
  run_once: true

- name: Download EasyRSA
  when: not register_easyrsa.stat.exists
  become: false
  get_url:
    url: "https://github.com/OpenVPN/easy-rsa/releases/download/v{{
     easyrsa_version }}/EasyRSA-v{{ easyrsa_version }}.tgz"
    dest: "/tmp/EasyRSA-latest.tgz"

- name: create {{ openvpn_easyrsa_path }} directory for unarchiving
  when: not register_easyrsa.stat.exists
  file:
    path: "{{ openvpn_easyrsa_path }}"
    state: directory

- name: Unarchive EasyRSA to {{ openvpn_easyrsa_path }}
  when: not register_easyrsa.stat.exists
  ansible.builtin.unarchive:
    src: "/tmp/EasyRSA-latest.tgz"
    dest: "{{ openvpn_easyrsa_path }}"
    extra_opts: [--strip-components=1]
    remote_src: true

- name: Add another bin dir to system-wide $PATH.
  copy:
    dest: /etc/profile.d/custom-path.sh
    content: 'PATH=$PATH:{{ openvpn_easyrsa_path }}'

- name: Easyrsa init-pki
  ansible.builtin.command:
    cmd: "{{ openvpn_easyrsa_path }}/easyrsa init-pki"
    chdir: /etc/openvpn/easy-rsa
    creates: /etc/openvpn/easy-rsa/pki

- name: Easyrsa build-ca
  ansible.builtin.command:
    cmd: "{{ openvpn_easyrsa_path }}/easyrsa build-ca nopass"
    chdir: /etc/openvpn/easy-rsa
    creates: /etc/openvpn/easy-rsa/pki/ca.crt
  environment:
    EASYRSA_BATCH: "yes"

- name: Easyrsa gen-dh
  ansible.builtin.command:
    cmd: "{{ openvpn_easyrsa_path }}/easyrsa gen-dh"
    chdir: /etc/openvpn/easy-rsa
    creates: /etc/openvpn/easy-rsa/pki/dh.pem

- name: Easyrsa build-server-full server nopass
  ansible.builtin.shell: echo 'yes' | {{ openvpn_easyrsa_path
   }}/easyrsa build-server-full server nopass
  args:
    chdir: /etc/openvpn/easy-rsa
    creates: /etc/openvpn/easy-rsa/pki/issued/server.crt

- name: Easyrsa build-client-full client nopass
  ansible.builtin.shell: echo 'yes' | {{ openvpn_easyrsa_path
   }}/easyrsa build-client-full client nopass
  args:
    chdir: /etc/openvpn/easy-rsa
    creates: /etc/openvpn/easy-rsa/pki/issued/client.crt

- name: Easyrsa gen-crl
  ansible.builtin.command:
    cmd: "{{ openvpn_easyrsa_path }}/easyrsa gen-crl"
    chdir: /etc/openvpn/easy-rsa
    creates: /etc/openvpn/easy-rsa/pki/crl.pem

- name: Openvpn --genkey --secret /etc/openvpn/easy-rsa/pki/ta.key
  ansible.builtin.command:
    cmd: openvpn --genkey --secret /etc/openvpn/easy-rsa/pki/ta.key
    creates: /etc/openvpn/easy-rsa/pki/ta.key

- name: Copy files to /etc/openvpn/server
  ansible.builtin.copy:
    src: /etc/openvpn/easy-rsa/pki/{{ item }}
    dest: /etc/openvpn/server/{{ item | basename }}
    mode: "0640"
    remote_src: true
  loop:
    - ca.crt
    - dh.pem
    - ta.key
    - issued/client.crt
    - issued/server.crt
    - private/ca.key
    - private/client.key
    - private/server.key

- name: Copy files to /etc/openvpn
  ansible.builtin.copy:
    src: /etc/openvpn/easy-rsa/pki/{{ item }}
    dest: /etc/openvpn/{{ item | basename }}
    mode: "0640"
    remote_src: true
  loop:
    - ca.crt
    - ta.key

- name: Place server.conf
  ansible.builtin.template:
    src: server.conf.j2
    dest: "{{ openvpn_configuration_directory }}/server/server.conf"
    owner: root
    group: root
    mode: "0640"
  notify:
    - restart openvpn-server

- name: Change pki directory owner
  file:
    path: "{{ openvpn_configuration_directory }}/easy-rsa/pki/"
    owner: ovpn-admin
    group: ovpn-admin
    recurse: true
    state: directory

- name: ensure ovpn-admin directory exists
  when: not register_ovpn_admin.stat.exists
  file:
    path: "{{ ovpn_admin_path }}"
    state: directory

- name: Unarchive ovpn-admin to {{ ovpn_admin_path }}
  when: not register_ovpn_admin.stat.exists
  ansible.builtin.unarchive:
    src: "https://github.com/flant/ovpn-admin/\
    releases/download/2.0.1/ovpn-admin-linux-amd64.tar.gz"
    dest: "{{ ovpn_admin_path }}"
    remote_src: true

- name: Place ovpn-admin systemd unit
  ansible.builtin.template:
    src: ovpn-admin.service.j2
    dest: "/lib/systemd/system/ovpn-admin.service"
    owner: root
    group: root
    mode: "0640"
  notify:
    - restart ovpn-admin

- name: Ensure nginx can connect to the network.
  seboolean:
    name: httpd_can_network_connect
    state: true
    persistent: true
  when: ansible_selinux.status == 'enabled'

- name: Create global htpasswd file
  htpasswd:
    path: /etc/nginx/ovpn_admin_htpasswd
    name: "{{ nginx_global_auth_username }}"
    password: "{{ nginx_global_auth_password }}"

- name: Delete default nginx site
  when: ansible_os_family == 'Debian'
  file:
    path: /etc/nginx/sites-enabled/default
    state: absent
  notify: restart nginx

- name: Delete default nginx site (RedHat)
  when: ansible_os_family == 'RedHat'
  ansible.builtin.template:
    src: redhat-nginx.conf.j2
    dest: "/etc/nginx/nginx.conf"
  notify:
    - restart nginx

- name: Place nginx site config (Debian)
  when: ansible_os_family == 'Debian'
  ansible.builtin.template:
    src: nginx-site.j2
    dest: "/etc/nginx/sites-enabled/ovpn-admin.conf"
  notify:
    - restart nginx

- name: Place nginx site config (RedHat)
  when: ansible_os_family == 'RedHat'
  ansible.builtin.template:
    src: nginx-site.j2
    dest: "/etc/nginx/conf.d/ovpn-admin.conf"
  notify:
    - restart nginx
